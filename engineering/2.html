<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>了解CSS Module作用域隔离原理 | 前端南玖</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/nanjiu/sy.jpg">
    <meta name="description" content="前端南玖的博客">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/nanjiu/assets/css/0.styles.fc0672a4.css" as="style"><link rel="preload" href="/nanjiu/assets/js/app.c35b6ae1.js" as="script"><link rel="preload" href="/nanjiu/assets/js/3.21869b4f.js" as="script"><link rel="preload" href="/nanjiu/assets/js/1.9b52f643.js" as="script"><link rel="preload" href="/nanjiu/assets/js/14.784aa51e.js" as="script"><link rel="prefetch" href="/nanjiu/assets/js/10.f1a27924.js"><link rel="prefetch" href="/nanjiu/assets/js/11.de75f91b.js"><link rel="prefetch" href="/nanjiu/assets/js/12.8bcb56f3.js"><link rel="prefetch" href="/nanjiu/assets/js/13.450e618a.js"><link rel="prefetch" href="/nanjiu/assets/js/15.7ce22294.js"><link rel="prefetch" href="/nanjiu/assets/js/16.2dd942a4.js"><link rel="prefetch" href="/nanjiu/assets/js/17.814c6270.js"><link rel="prefetch" href="/nanjiu/assets/js/18.50331e0c.js"><link rel="prefetch" href="/nanjiu/assets/js/19.515821f6.js"><link rel="prefetch" href="/nanjiu/assets/js/20.f2e00966.js"><link rel="prefetch" href="/nanjiu/assets/js/21.742783bd.js"><link rel="prefetch" href="/nanjiu/assets/js/22.5cae6111.js"><link rel="prefetch" href="/nanjiu/assets/js/23.552dd835.js"><link rel="prefetch" href="/nanjiu/assets/js/24.80e3e28e.js"><link rel="prefetch" href="/nanjiu/assets/js/25.21215dcf.js"><link rel="prefetch" href="/nanjiu/assets/js/26.8a9f3742.js"><link rel="prefetch" href="/nanjiu/assets/js/27.dd584b99.js"><link rel="prefetch" href="/nanjiu/assets/js/28.b2ccf361.js"><link rel="prefetch" href="/nanjiu/assets/js/29.bdfe0d3f.js"><link rel="prefetch" href="/nanjiu/assets/js/30.5b873c0b.js"><link rel="prefetch" href="/nanjiu/assets/js/31.cc2cb3c5.js"><link rel="prefetch" href="/nanjiu/assets/js/32.7d0c815a.js"><link rel="prefetch" href="/nanjiu/assets/js/33.621180eb.js"><link rel="prefetch" href="/nanjiu/assets/js/34.fa215925.js"><link rel="prefetch" href="/nanjiu/assets/js/35.fa888c0a.js"><link rel="prefetch" href="/nanjiu/assets/js/36.1ff0bd80.js"><link rel="prefetch" href="/nanjiu/assets/js/37.0364a7c2.js"><link rel="prefetch" href="/nanjiu/assets/js/38.afc5ac1f.js"><link rel="prefetch" href="/nanjiu/assets/js/39.5f163a4d.js"><link rel="prefetch" href="/nanjiu/assets/js/4.38958b26.js"><link rel="prefetch" href="/nanjiu/assets/js/40.4ac92165.js"><link rel="prefetch" href="/nanjiu/assets/js/41.6a41eff2.js"><link rel="prefetch" href="/nanjiu/assets/js/42.095e8dbf.js"><link rel="prefetch" href="/nanjiu/assets/js/5.9d762e5c.js"><link rel="prefetch" href="/nanjiu/assets/js/6.ef23ec35.js"><link rel="prefetch" href="/nanjiu/assets/js/7.cc01232d.js"><link rel="prefetch" href="/nanjiu/assets/js/8.7cc91b88.js"><link rel="prefetch" href="/nanjiu/assets/js/9.e2d6a32d.js">
    <link rel="stylesheet" href="/nanjiu/assets/css/0.styles.fc0672a4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>前端南玖</h3> <p class="description" data-v-59e6cb88>前端南玖的博客</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nanjiu/" class="home-link router-link-active"><img src="/nanjiu/logo.png" alt="前端南玖" class="logo"> <span class="site-name">前端南玖</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nanjiu/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/htmlcss/" class="nav-link"><i class="undefined"></i>
  HTML&amp;CSS
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/javascript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/miniprogram/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程化
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/webpack/" class="nav-link"><i class="undefined"></i>
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/engineering/" class="nav-link router-link-active"><i class="undefined"></i>
  合集
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Node
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/nest/" class="nav-link"><i class="undefined"></i>
  Nest
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/npm/" class="nav-link"><i class="undefined"></i>
  Npm
</a></li></ul></div></div><div class="nav-item"><a href="/nanjiu/flutter/" class="nav-link"><i class="undefined"></i>
  Flutter
</a></div><div class="nav-item"><a href="/nanjiu/performance/" class="nav-link"><i class="undefined"></i>
  性能优化
</a></div><div class="nav-item"><a href="/nanjiu/about/" class="nav-link"><i class="undefined"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/nanjiu/sy.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>32</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>14</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#849b87;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-juejin" style="color:#fb9b5f;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-zhihu" style="color:#849b87;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/nanjiu/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/htmlcss/" class="nav-link"><i class="undefined"></i>
  HTML&amp;CSS
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/javascript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/miniprogram/" class="nav-link"><i class="undefined"></i>
  小程序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程化
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/webpack/" class="nav-link"><i class="undefined"></i>
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/engineering/" class="nav-link router-link-active"><i class="undefined"></i>
  合集
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Node
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/nest/" class="nav-link"><i class="undefined"></i>
  Nest
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/npm/" class="nav-link"><i class="undefined"></i>
  Npm
</a></li></ul></div></div><div class="nav-item"><a href="/nanjiu/flutter/" class="nav-link"><i class="undefined"></i>
  Flutter
</a></div><div class="nav-item"><a href="/nanjiu/performance/" class="nav-link"><i class="undefined"></i>
  性能优化
</a></div><div class="nav-item"><a href="/nanjiu/about/" class="nav-link"><i class="undefined"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>babel</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nanjiu/engineering/" aria-current="page" class="sidebar-link">从Babel开始认识AST抽象语法树</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>postcss</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nanjiu/engineering/2.html" aria-current="page" class="active sidebar-link">了解CSS Module作用域隔离原理</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>了解CSS Module作用域隔离原理</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">了解CSS Module作用域隔离原理</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>南玖</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023/6/25</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/nanjiu/engineering/2.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>postcss</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="css-module出现的背景"><a href="#css-module出现的背景" class="header-anchor">#</a> CSS Module出现的背景</h2> <p>我们知道，Javascript发展到现在出现了众多模块化规范，比如AMD、CMD、 Common JS、ESModule等，这些模块化规范能够让我们的JS实现作用域隔离。但CSS却并没有这么幸运，发展到现在却一直没有模块化规范，由于CSS是 根据选择器去全局匹配元素的，所以如果你在页面的两个不同的地方定义了一个相同的类名，先定义的样式就会被后定义的覆盖掉。由于这个原因，CSS的命名冲突一直困扰着前端人员。</p> <p>这种现状是前端开发者不能接受的，所以CSS社区也诞生了各种各样的CSS模块化解决方案（这并不是规范），比如：</p> <ul><li><strong>命名方法：</strong> 人为约定命名规则</li> <li><strong>scoped：</strong> vue中常见隔离方式</li> <li><strong>CSS Module：</strong> 每个文件都是一个独立的模块</li> <li><strong>CSS-in-JS：</strong> 这个常见于react、 JSX中</li></ul> <p>现在来看<code>CSS Module</code>是目前最为流行的一种解决方案，它能够与CSS预处理器搭配使用在各种框架中。</p> <p><strong>如果这篇文章有帮助到你，❤️关注+点赞❤️鼓励一下作者，文章公众号首发，关注 <code>前端南玖</code> 第一时间获取最新文章～</strong></p> <h2 id="css-module"><a href="#css-module" class="header-anchor">#</a> CSS Module</h2> <blockquote><p>CSS Module的流行源于React社区，它获得了社区的迅速采用，后面由于Vue-cli对其集成后开箱即用的支持，将其推到了一个新高度。</p></blockquote> <h3 id="局部作用域"><a href="#局部作用域" class="header-anchor">#</a> 局部作用域</h3> <p><strong>在w3c 规范中，CSS 始终是「全局生效的」。在传统的 web 开发中，最为头痛的莫过于处理 CSS 问题。因为全局性，明明定义了样式，但就是不生效，原因可能是被其他样式定义所强制覆盖。</strong></p> <p>产生局部作用域的唯一方法就是为样式取一个独一无二的名字，<code>CSS Module</code>也就是用这个方法来实现作用域隔离的。</p> <p>在CSS Module中可以使用<code>:local(className)</code>来声明一个局部作用域的CSS规则。</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">:local(.qd_btn)</span> <span class="token punctuation">{</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">:local(.qd_btn):nth(1)</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> pink<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">:local(.qd_title)</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>CSS Module</code>会对<code>:local()</code>包含的选择器做<code>localIdentName</code>规则处理，也就是为其生成一个唯一的选择器名称，以达到作用域隔离的效果。</p> <p>以上css经过编译后会生成这样的代码：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03f8eacc1e05407e9374d8c66b78db07~tplv-k3u1fbpfcp-watermark.image?" alt="css-1.png"></p> <p>这里的<code>:export</code>是CSS Module为解决导出而新增的伪类，后面再进行介绍</p> <h3 id="全局作用域"><a href="#全局作用域" class="header-anchor">#</a> 全局作用域</h3> <p>当然CSS Module也允许使用<code>:global(className)</code>来声明一个全局作用域的规则。</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">:global(.qd_text)</span> <span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> chocolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而对于<code>:global()</code>包含的选择器<code>CSS Module</code>则不会做任何处理，因为CSS规则默认就是全局的。</p> <p>或许很多了会好奇我们在开发过程好像很少使用到<code>:local()</code>，比如在vue中，我们只要在style标签上加上<code>module</code>就能自动达到作用域隔离的效果。</p> <p>是的，为了我们开发过程方便，<code>postcss-modules-local-by-default</code>插件已经默认帮我们处理了这一步，只要我们开启了CSS模块化，里面的CSS在编译过程会默认加上<code>:local()</code>。</p> <h3 id="composing-组合"><a href="#composing-组合" class="header-anchor">#</a> Composing(组合)</h3> <p>组合的意思就是一个选择器可以继承另一个选择器的规则。</p> <h4 id="继承当前文件内容"><a href="#继承当前文件内容" class="header-anchor">#</a> 继承当前文件内容</h4> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">:local(.qd_btn)</span> <span class="token punctuation">{</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
    <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">:local(.qd_title)</span> <span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
    <span class="token property">composes</span><span class="token punctuation">:</span> qd_btn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b92f850db0ec43e58bff441caf6a1567~tplv-k3u1fbpfcp-watermark.image?" alt="css-2.png"></p> <h4 id="继承其它文件"><a href="#继承其它文件" class="header-anchor">#</a> 继承其它文件</h4> <p>Composes 还可以继承外部文件中的样式</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/* a.css */</span>
<span class="token selector">:local(.a_btn)</span> <span class="token punctuation">{</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid salmon<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/** default.css **/</span>
<span class="token selector">.qd_box</span> <span class="token punctuation">{</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span>
    <span class="token property">composes</span><span class="token punctuation">:</span> a_btn from <span class="token string">'a.css'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>编译后会生成如下代码：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/971c0de8563f45329e4d7341720928e8~tplv-k3u1fbpfcp-watermark.image?" alt="css-3.png"></p> <h3 id="导入导出"><a href="#导入导出" class="header-anchor">#</a> 导入导出</h3> <p>从上面的这些编译结果我们会发现有两个我们平时没用过的伪类：<code>:import</code>、<code>:export</code>。</p> <p>CSS Module 内部通过<code>ICSS</code>来解决CSS的导入导出问题，对应的就是上面两个新增的伪类。</p> <blockquote><p>Interoperable CSS (ICSS) 是标准 CSS 的超集。</p></blockquote> <h4 id="import"><a href="#import" class="header-anchor">#</a> :import</h4> <p>语句<code>:import</code>允许从其他 CSS 文件导入变量。它执行以下操作：</p> <ul><li>获取并处理依赖项</li> <li>根据导入的令牌解析依赖项的导出，并将它们匹配到<code>localAlias</code></li> <li>在当前文件中的某些地方（如下所述）查找和替换使用<code>localAlias</code>依赖项的<code>exportedValue</code>.</li></ul> <h4 id="export"><a href="#export" class="header-anchor">#</a> :export</h4> <p>一个<code>:export</code>块定义了将要导出给消费者的符号。可以认为它在功能上等同于以下 JS：</p> <div class="language- extra-class"><pre class="language-text"><code>module.exports = {
	&quot;exportedKey&quot;: &quot;exportedValue&quot;
}
</code></pre></div><p>语法上有以下限制<code>:export</code>：</p> <ul><li>它必须在顶层，但可以在文件中的任何位置。</li> <li>如果一个文件中有多个，则将键和值组合在一起并一起导出。</li> <li>如果<code>exportedKey</code>重复某个特定项，则最后一个（按源顺序）优先。</li> <li>An<code>exportedValue</code>可以包含对 CSS 声明值有效的任何字符（包括空格）。</li> <li><code>exportedValue</code>不需要引用an ，它已被视为文字字符串。</li></ul> <p>以下是输出可读性所需要的，但不是强制的：</p> <ul><li>应该只有一个<code>:export</code>块</li> <li>它应该位于文件的顶部，但在任何<code>:import</code>块之后</li></ul> <h2 id="css-module原理"><a href="#css-module原理" class="header-anchor">#</a> CSS Module原理</h2> <p>大概了解完CSS Module语法后，我们可以再来看看它的内部实现，以及它的核心原理 —— 作用域隔离。</p> <p>一般来讲，我们平时在开发中使用起来没有这么麻烦，比如我们在vue项目中能够做到开箱即用，最主要的插件就是<code>css-loader</code>，我们可以从这里入手一探究竟。</p> <p><strong>这里大家可以思考下，<code>css-loader</code>主要会依赖哪些库来进行处理？</strong></p> <p>我们要知道，<code>CSS Module</code>新增的这些语法其实并不是CSS 内置语法，那么它就一定需要进行编译处理</p> <p>那么编译CSS我们最先想到的是哪个库？</p> <p>postcss对吧？它对于CSS就像Babel对于javascript</p> <p>可以安装<code>css-loader</code>来验证一下:</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57682abdbd9848cd8af11f93394c745c~tplv-k3u1fbpfcp-watermark.image?" alt="css-4.png"></p> <p>跟我们预期的一致，这里我们能看到几个以<code>postcss-module</code>开头的插件，这些应该就是实现CSS Module的核心插件。</p> <p>从上面这些插件名称应该能看出哪个才是实现作用域隔离的吧</p> <ul><li>Postcss-modules-extract-imports：导入导出功能</li> <li>Postcss-modules-local-by-default：默认局部作用域</li> <li>Postcss-modules-scope：作用域隔离</li> <li>Posts-modules-values：变量功能</li></ul> <h3 id="编译流程"><a href="#编译流程" class="header-anchor">#</a> 编译流程</h3> <p>整个流程大体上跟Babel编译javascript类似：parse ——&gt; transform ——&gt; stringier</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d07eb2f7c4a4cb7885adb13fd0e6faf~tplv-k3u1fbpfcp-watermark.image?" alt="css-5.png"></p> <p>与Babel不同的是，PostCSS自身只包括css分析器，css节点树API，source map生成器以及css节点树拼接器。</p> <p>css的组成单元是一条一条的样式规则（rule），每一条样式规则又包含一个或多个属性&amp;值的定义。所以，PostCSS的执行过程是，先css分析器读取css字符内容，得到一个完整的节点树，接下来，对该节点树进行一系列转换操作（基于节点树API的插件），最后，由css节点树拼接器将转换后的节点树重新组成css字符。期间可生成source map表明转换前后的字符对应关系。</p> <p>CSS在编译期间也是需要生成AST得，这点与Babel处理JS一样。</p> <h3 id="ast"><a href="#ast" class="header-anchor">#</a> AST</h3> <p>PostCSS的AST主要有以下这四种：</p> <ul><li>rule: 选择器开头</li></ul> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">#main</span> <span class="token punctuation">{</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid black<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>atrule: 以<code>@</code>开头</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>@media screen <span class="token function">and</span> <span class="token punctuation">(</span><span class="token parameter">min<span class="token operator">-</span>width<span class="token operator">:</span> 480px</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    body <span class="token punctuation">{</span>
        background<span class="token operator">-</span>color<span class="token operator">:</span> lightgreen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>decl: 具体样式规则</li></ul> <div class="language-css extra-class"><pre class="language-css"><code><span class="token property">border</span><span class="token punctuation">:</span> 1px solid black<span class="token punctuation">;</span>
</code></pre></div><ul><li>comment: 注释</li></ul> <div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/* 注释*/</span>
</code></pre></div><p>与Babel类似，这些我们同样可以使用工具来更清晰地了解CSS 的 AST：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b81f7f82725e4c148cc3b7233a1f404e~tplv-k3u1fbpfcp-watermark.image?" alt="css-6.png"></p> <ul><li>Root: 继承自 Container。AST 的根节点，代表整个 css 文件</li> <li>AtRule: 继承自 Container。以 @ 开头的语句，核心属性为 params，例如： <code>@import url('./default.css')</code>，params 为<code>url('./default.css')</code></li> <li>Rule: 继承自 Container。带有声明的选择器，核心属性为 selector，例如：<code>.color2{}</code>，selector为<code>.color2</code></li> <li>Comment: 继承自 Node。标准的注释/* 注释 */ 节点包括一些通用属性:</li> <li>type：节点类型</li> <li>parent：父节点</li> <li>source：存储节点的资源信息，计算 sourcemap</li> <li>start：节点的起始位置</li> <li>end：节点的终止位置</li> <li>raws：存储节点的附加符号，分号、空格、注释等，在 stringify 过程中会拼接这些附加符号</li></ul> <h3 id="安装体验"><a href="#安装体验" class="header-anchor">#</a> 安装体验</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i postcss postcss-modules-extract-imports postcss-modules-local-by-default postcss-modules-scope postcss-selector-parser
</code></pre></div><p>这些插件的功能我们都可以自己一一去体验，我们先将这些主要的插件串联起来试一试效果，再来自行实现一个<code>Postcss-modules-scope</code>插件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token string">'./css/default.css'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token function">postcssModulesLocalByDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">postcssModulesExtractImports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token function">postcssModulesScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> res <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'【output】'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>css<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>把这几个核心插件集成进来，我们会发现，我们的css中的样式不用再写<code>:local</code>也能生成唯一hash名称了，并且也能够导入其它文件的样式了。这主要是依靠<code>postcss-modules-local-by-default</code>、<code>postcss-modules-extract-imports</code>两个插件。</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/* default.css */</span>
<span class="token selector">.qd_box</span> <span class="token punctuation">{</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ccc<span class="token punctuation">;</span>
    <span class="token property">composes</span><span class="token punctuation">:</span> a_btn from <span class="token string">'a.css'</span>
<span class="token punctuation">}</span>
<span class="token selector">.qd_header</span> <span class="token punctuation">{</span>
    <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
    <span class="token property">justify-content</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">align-items</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
    <span class="token property">composes</span><span class="token punctuation">:</span> qd_box<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.qd_box</span> <span class="token punctuation">{</span>
    <span class="token property">background</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18621a7728a2422ab5c469057e33b952~tplv-k3u1fbpfcp-watermark.image?" alt="css-7.png"></p> <h3 id="编写插件"><a href="#编写插件" class="header-anchor">#</a> 编写插件</h3> <p>现在我们就自己来实现一下类似<code>postcss-modules-scope</code>的插件吧，其实原理很简单，就是遍历AST，为选择器生成一个唯一的名字，并将其与选择器的名称维护在<code>exports</code>里面。</p> <h5 id="主要api"><a href="#主要api" class="header-anchor">#</a> 主要API</h5> <p>说到遍历AST，与Babel相似Post CSS也同样提供了很多API用于操作AST：</p> <ul><li><strong>walk:</strong>  遍历所有节点信息</li> <li><strong>walkAtRules:</strong>  遍历所有<code>atrule</code> 类型节点</li> <li><strong>walkRules:</strong> 遍历所有<code>rule</code>类型节点</li> <li><strong>walkComments:</strong> 遍历所有 <code>comment</code> 类型节点</li> <li><strong>walkDecls:</strong> 遍历所有 <code>decl</code>类型节点</li></ul> <p>(更多内容可在postcss文档上查看)</p> <p>有了这些API我们处理AST就非常方便了</p> <h5 id="插件格式"><a href="#插件格式" class="header-anchor">#</a> 插件格式</h5> <p>编写PostCSS插件与Babel类似，我们只需要按照它的规范进行处理AST就行，至于它的编译以及目标代码生成我们都不需要关心。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">plugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">postcssPlugin</span><span class="token operator">:</span> <span class="token string">'plugin name'</span><span class="token punctuation">,</span>
    <span class="token function">Once</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每个文件都会调用一次，类似Babel的visitor</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

plugin<span class="token punctuation">.</span>postcss <span class="token operator">=</span> <span class="token boolean">true</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> plugin
</code></pre></div><h5 id="核心代码"><a href="#核心代码" class="header-anchor">#</a> 核心代码</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> selectorParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;postcss-selector-parser&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 随机生成一个选择器名称</span>
<span class="token keyword">const</span> <span class="token function-variable function">createScopedName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> randomStr <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>randomStr<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">__</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">plugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">postcssPlugin</span><span class="token operator">:</span> <span class="token string">'css-module-plugin'</span><span class="token punctuation">,</span>
        <span class="token function">Once</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> helpers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment">// 导出 scopedName</span>
            <span class="token keyword">function</span> <span class="token function">exportScopedName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// css名称与其对应的作用域名城的映射</span>
                <span class="token keyword">const</span> scopedName <span class="token operator">=</span> <span class="token function">createScopedName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>scopedName<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    exports<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>scopedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> scopedName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 本地节点，也就是需要作用域隔离的节点:local()</span>
            <span class="token keyword">function</span> <span class="token function">localizeNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span>
                        node<span class="token punctuation">.</span>nodes <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>localizeNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;class&quot;</span><span class="token operator">:</span>
                        <span class="token keyword">return</span> selectorParser<span class="token punctuation">.</span><span class="token function">className</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">exportScopedName</span><span class="token punctuation">(</span>
                                node<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                                node<span class="token punctuation">.</span>raws <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>raws<span class="token punctuation">.</span>value <span class="token operator">?</span> node<span class="token punctuation">.</span>raws<span class="token punctuation">.</span>value <span class="token operator">:</span> <span class="token keyword">null</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> selectorParser<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                            <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token function">exportScopedName</span><span class="token punctuation">(</span>
                                node<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
                                node<span class="token punctuation">.</span>raws <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>raws<span class="token punctuation">.</span>value <span class="token operator">?</span> node<span class="token punctuation">.</span>raws<span class="token punctuation">.</span>value <span class="token operator">:</span> <span class="token keyword">null</span>
                            <span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 遍历节点</span>
            <span class="token keyword">function</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// console.log('【node】', node)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token function">localizeNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">,</span> node<span class="token punctuation">.</span>spaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> node
                <span class="token punctuation">}</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;root&quot;</span><span class="token operator">:</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                        node<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>traverseNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 选择器</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;id&quot;</span><span class="token operator">:</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;class&quot;</span><span class="token operator">:</span>
                        exports<span class="token punctuation">[</span>node<span class="token punctuation">.</span>value<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>node<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment">// 伪元素</span>
                    <span class="token keyword">case</span> <span class="token string">&quot;pseudo&quot;</span><span class="token operator">:</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;:local&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">const</span> selector <span class="token operator">=</span> <span class="token function">localizeNode</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>first<span class="token punctuation">,</span> node<span class="token punctuation">.</span>spaces<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            node<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token string">&quot;:global&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> node<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 遍历所有rule类型节点</span>
            root<span class="token punctuation">.</span><span class="token function">walkRules</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> parsedSelector <span class="token operator">=</span> <span class="token function">selectorParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">astSync</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
                rule<span class="token punctuation">.</span>selector <span class="token operator">=</span> <span class="token function">traverseNode</span><span class="token punctuation">(</span>parsedSelector<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 遍历所有decl类型节点 处理 composes</span>
                rule<span class="token punctuation">.</span><span class="token function">walkDecls</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">composes|compose-with</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">decl</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> localNames <span class="token operator">=</span> parsedSelector<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> node<span class="token punctuation">.</span>nodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>first<span class="token punctuation">.</span>first<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token keyword">const</span> classes <span class="token operator">=</span> decl<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    classes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">className</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> global <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^global\(([^)]+)\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// console.log(exports, className, '-----')</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>global<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            localNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">exportedName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                exports<span class="token punctuation">[</span>exportedName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>global<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            localNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">exportedName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                exports<span class="token punctuation">[</span>className<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                                    exports<span class="token punctuation">[</span>exportedName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    decl<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 处理 @keyframes</span>
            root<span class="token punctuation">.</span><span class="token function">walkAtRules</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">keyframes$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">atRule</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> localMatch <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^:local\((.*)\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>atRule<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>localMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    atRule<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token function">exportScopedName</span><span class="token punctuation">(</span>localMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 生成 :export rule</span>
            <span class="token keyword">const</span> exportedNames <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>exportedNames<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> exportRule <span class="token operator">=</span> helpers<span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token string">&quot;:export&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                exportedNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">exportedName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    exportRule<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">prop</span><span class="token operator">:</span> exportedName<span class="token punctuation">,</span>
                        <span class="token literal-property property">value</span><span class="token operator">:</span> exports<span class="token punctuation">[</span>exportedName<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">raws</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">before</span><span class="token operator">:</span> <span class="token string">&quot;\n  &quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                root<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>exportRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
plugin<span class="token punctuation">.</span>postcss <span class="token operator">=</span> <span class="token boolean">true</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> plugin
</code></pre></div><h5 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> css <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getCode</span><span class="token punctuation">(</span><span class="token string">'./css/index.css'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> pipeline <span class="token operator">=</span> <span class="token function">postcss</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token function">postcssModulesLocalByDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">postcssModulesExtractImports</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/css-module-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'【output】'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>css<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>原文首发地址<a href="https://mp.weixin.qq.com/s/PVfKWMgE6lQaehBymVpkFQ" target="_blank" rel="noopener noreferrer">点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，欢迎大家关注公众号 <strong>「前端南玖」</strong>，如果你想进前端交流群一起学习，<a href="https://juejin.cn/pin/7072217320155775007" target="_blank" rel="noopener noreferrer">请点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><strong>我是南玖，我们下期见！！！</strong></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/nanjiu/engineering/" class="prev router-link-active">
          从Babel开始认识AST抽象语法树
        </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#css-module出现的背景" class="sidebar-link reco-side-css-module出现的背景" data-v-b57cc07c>CSS Module出现的背景</a></li><li class="level-2" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#css-module" class="sidebar-link reco-side-css-module" data-v-b57cc07c>CSS Module</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#局部作用域" class="sidebar-link reco-side-局部作用域" data-v-b57cc07c>局部作用域</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#全局作用域" class="sidebar-link reco-side-全局作用域" data-v-b57cc07c>全局作用域</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#composing-组合" class="sidebar-link reco-side-composing-组合" data-v-b57cc07c>Composing(组合)</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#导入导出" class="sidebar-link reco-side-导入导出" data-v-b57cc07c>导入导出</a></li><li class="level-2" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#css-module原理" class="sidebar-link reco-side-css-module原理" data-v-b57cc07c>CSS Module原理</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#编译流程" class="sidebar-link reco-side-编译流程" data-v-b57cc07c>编译流程</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#ast" class="sidebar-link reco-side-ast" data-v-b57cc07c>AST</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#安装体验" class="sidebar-link reco-side-安装体验" data-v-b57cc07c>安装体验</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/engineering/2.html#编写插件" class="sidebar-link reco-side-编写插件" data-v-b57cc07c>编写插件</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/nanjiu/assets/js/app.c35b6ae1.js" defer></script><script src="/nanjiu/assets/js/3.21869b4f.js" defer></script><script src="/nanjiu/assets/js/1.9b52f643.js" defer></script><script src="/nanjiu/assets/js/14.784aa51e.js" defer></script>
  </body>
</html>
