<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>pnpm才是前端工程化项目的未来 | 前端南玖</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/nanjiu/sy.jpg">
    <meta name="description" content="前端南玖的博客">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/nanjiu/assets/css/0.styles.fc0672a4.css" as="style"><link rel="preload" href="/nanjiu/assets/js/app.76cb9285.js" as="script"><link rel="preload" href="/nanjiu/assets/js/3.21869b4f.js" as="script"><link rel="preload" href="/nanjiu/assets/js/1.9b52f643.js" as="script"><link rel="preload" href="/nanjiu/assets/js/34.a7a58004.js" as="script"><link rel="prefetch" href="/nanjiu/assets/js/10.f1a27924.js"><link rel="prefetch" href="/nanjiu/assets/js/11.de75f91b.js"><link rel="prefetch" href="/nanjiu/assets/js/12.f2235a6b.js"><link rel="prefetch" href="/nanjiu/assets/js/13.d13adf12.js"><link rel="prefetch" href="/nanjiu/assets/js/14.ff2ac999.js"><link rel="prefetch" href="/nanjiu/assets/js/15.c06fff87.js"><link rel="prefetch" href="/nanjiu/assets/js/16.a3000c8f.js"><link rel="prefetch" href="/nanjiu/assets/js/17.f8b2bfdf.js"><link rel="prefetch" href="/nanjiu/assets/js/18.1d8a92f2.js"><link rel="prefetch" href="/nanjiu/assets/js/19.2946e000.js"><link rel="prefetch" href="/nanjiu/assets/js/20.f2e00966.js"><link rel="prefetch" href="/nanjiu/assets/js/21.742783bd.js"><link rel="prefetch" href="/nanjiu/assets/js/22.dc3c16cb.js"><link rel="prefetch" href="/nanjiu/assets/js/23.eb3a3737.js"><link rel="prefetch" href="/nanjiu/assets/js/24.80e3e28e.js"><link rel="prefetch" href="/nanjiu/assets/js/25.937e6f0d.js"><link rel="prefetch" href="/nanjiu/assets/js/26.24cd5627.js"><link rel="prefetch" href="/nanjiu/assets/js/27.04a0a4e3.js"><link rel="prefetch" href="/nanjiu/assets/js/28.26ccd3df.js"><link rel="prefetch" href="/nanjiu/assets/js/29.c0b84bca.js"><link rel="prefetch" href="/nanjiu/assets/js/30.d3f66dc7.js"><link rel="prefetch" href="/nanjiu/assets/js/31.d3028123.js"><link rel="prefetch" href="/nanjiu/assets/js/32.164d52be.js"><link rel="prefetch" href="/nanjiu/assets/js/33.54142859.js"><link rel="prefetch" href="/nanjiu/assets/js/35.7e4bdc27.js"><link rel="prefetch" href="/nanjiu/assets/js/36.9652e253.js"><link rel="prefetch" href="/nanjiu/assets/js/37.b78bff21.js"><link rel="prefetch" href="/nanjiu/assets/js/38.d3d9c03d.js"><link rel="prefetch" href="/nanjiu/assets/js/39.ae16f805.js"><link rel="prefetch" href="/nanjiu/assets/js/4.38958b26.js"><link rel="prefetch" href="/nanjiu/assets/js/40.5c032f69.js"><link rel="prefetch" href="/nanjiu/assets/js/5.9d762e5c.js"><link rel="prefetch" href="/nanjiu/assets/js/6.ef23ec35.js"><link rel="prefetch" href="/nanjiu/assets/js/7.cc01232d.js"><link rel="prefetch" href="/nanjiu/assets/js/8.7cc91b88.js"><link rel="prefetch" href="/nanjiu/assets/js/9.0d05c13b.js">
    <link rel="stylesheet" href="/nanjiu/assets/css/0.styles.fc0672a4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>前端南玖</h3> <p class="description" data-v-59e6cb88>前端南玖的博客</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/nanjiu/" class="home-link router-link-active"><img src="/nanjiu/logo.png" alt="前端南玖" class="logo"> <span class="site-name">前端南玖</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/nanjiu/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/htmlcss/" class="nav-link"><i class="undefined"></i>
  HTML&amp;CSS
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/javascript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程化
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/webpack/" class="nav-link"><i class="undefined"></i>
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/engineering/" class="nav-link"><i class="undefined"></i>
  合集
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Node
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/nest/" class="nav-link"><i class="undefined"></i>
  Nest
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/npm/" class="nav-link router-link-active"><i class="undefined"></i>
  Npm
</a></li></ul></div></div><div class="nav-item"><a href="/nanjiu/flutter/" class="nav-link"><i class="undefined"></i>
  Flutter
</a></div><div class="nav-item"><a href="/nanjiu/performance/" class="nav-link"><i class="undefined"></i>
  性能优化
</a></div><div class="nav-item"><a href="/nanjiu/about/" class="nav-link"><i class="undefined"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/nanjiu/sy.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>30</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>12</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41><li class="social-item" data-v-1fad0c41><i class="iconfont reco-github" style="color:#f26d6d;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-juejin" style="color:#abbd81;" data-v-1fad0c41></i></li><li class="social-item" data-v-1fad0c41><i class="iconfont reco-zhihu" style="color:#e15b64;" data-v-1fad0c41></i></li></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/nanjiu/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/htmlcss/" class="nav-link"><i class="undefined"></i>
  HTML&amp;CSS
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/javascript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      工程化
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/webpack/" class="nav-link"><i class="undefined"></i>
  webpack
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/docker/" class="nav-link"><i class="undefined"></i>
  docker
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/engineering/" class="nav-link"><i class="undefined"></i>
  合集
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      Node
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nanjiu/nest/" class="nav-link"><i class="undefined"></i>
  Nest
</a></li><li class="dropdown-item"><!----> <a href="/nanjiu/npm/" class="nav-link router-link-active"><i class="undefined"></i>
  Npm
</a></li></ul></div></div><div class="nav-item"><a href="/nanjiu/flutter/" class="nav-link"><i class="undefined"></i>
  Flutter
</a></div><div class="nav-item"><a href="/nanjiu/performance/" class="nav-link"><i class="undefined"></i>
  性能优化
</a></div><div class="nav-item"><a href="/nanjiu/about/" class="nav-link"><i class="undefined"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>NPM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/nanjiu/npm/" aria-current="page" class="sidebar-link">熟悉又陌生的package.json</a></li><li><a href="/nanjiu/npm/2package-lock.html" class="sidebar-link">关于package-lock.json</a></li><li><a href="/nanjiu/npm/3.html" aria-current="page" class="active sidebar-link">pnpm才是前端工程化项目的未来</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>pnpm才是前端工程化项目的未来</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">pnpm才是前端工程化项目的未来</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>南玖</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2023/6/25</span></i> <i class="iconfont reco-eye" data-v-8a445198><span id="/nanjiu/npm/3.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-8a445198><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>npm</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>相信小伙伴们都接触过<code>npm/yarn</code>，这两种包管理工具想必是大家工作中用的最多的包管理工具，<code>npm</code>作为<code>node</code>官方的包管理工具，它是随着node的诞生一起出现在大家的视野中，而<code>yarn</code>的出现则是为了解决<code>npm</code>带来的诸多问题，虽然<code>yarn</code>提高了依赖包的安装速度与使用体验，但它依旧没有解决<code>npm</code>的依赖重复安装等致命问题。<strong>pnpm</strong>的出现完美解决了依赖包重复安装的问题，并且实现了<code>yarn</code>带来的所有优秀体验，所以说<strong>pnpm才是前端工程化项目的未来</strong>。</p> <p><strong>如果这篇文章有帮助到你，❤️关注+点赞❤️鼓励一下作者，文章公众号首发，关注 <code>前端南玖</code> 第一时间获取最新文章～</strong></p> <h2 id="npm-与-yarn-存在的问题"><a href="#npm-与-yarn-存在的问题" class="header-anchor">#</a> npm 与 yarn 存在的问题</h2> <h3 id="早期的npm"><a href="#早期的npm" class="header-anchor">#</a> 早期的npm</h3> <p>在npm@3之前，<code>node_modules</code>结构可以说是<code>整洁</code>、<code>可预测</code>的，因为当时的依赖结构是这样的：</p> <div class="language-js extra-class"><pre class="language-js"><code>node_modules 
└─ 依赖<span class="token constant">A</span> 
   ├─ index<span class="token punctuation">.</span>js 
   ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json 
   └─ node_modules 
       └─ 依赖<span class="token constant">B</span> 
       ├─ index<span class="token punctuation">.</span>js 
       └─ <span class="token keyword">package</span><span class="token punctuation">.</span>json
 └─ 依赖<span class="token constant">C</span> 
   ├─ index<span class="token punctuation">.</span>js 
   ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json 
   └─ node_modules 
       └─ 依赖<span class="token constant">B</span> 
       ├─ index<span class="token punctuation">.</span>js 
       └─ <span class="token keyword">package</span><span class="token punctuation">.</span>json
</code></pre></div><p>每个依赖下面都维护着自己的<code>node_modules</code>，这样看起来确实非常整洁，但同时也带来一些较为严重的问题：</p> <ul><li>依赖包重复安装</li> <li>依赖层级过多</li> <li>模块实例无法共享</li></ul> <h4 id="依赖包重复安装"><a href="#依赖包重复安装" class="header-anchor">#</a> 依赖包重复安装</h4> <p>从上面的依赖结构我们可以看出，依赖A与依赖C同时引用了依赖B，此时的依赖B会被下载两次。此刻我们想想要是某一个依赖被引用了n次，那么它就需要被下载n次。（此时心里是不是在想，怎么会有如此坑的设计）</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12c0ee79e66f4ce7b8cd37b1cfac66ff~tplv-k3u1fbpfcp-watermark.image?" alt="01203040_0.jpeg"></p> <h4 id="依赖层级过多"><a href="#依赖层级过多" class="header-anchor">#</a> 依赖层级过多</h4> <p>我们再来看另外一种依赖结构：</p> <div class="language-js extra-class"><pre class="language-js"><code>node_modules 
└─ 依赖<span class="token constant">A</span> 
   ├─ index<span class="token punctuation">.</span>js 
   ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json 
   └─ node_modules 
       └─ 依赖<span class="token constant">B</span> 
       ├─ index<span class="token punctuation">.</span>js 
       ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json
       └─ node_modules 
           └─ 依赖<span class="token constant">C</span> 
           ├─ index<span class="token punctuation">.</span>js 
           ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json 
           └─ node_modules 
               └─ 依赖<span class="token constant">D</span> 
               ├─ index<span class="token punctuation">.</span>js 
               └─ <span class="token keyword">package</span><span class="token punctuation">.</span>json
</code></pre></div><p>这种依赖层级少还能接受，要是依赖层级多了，这样一层一层嵌套下去，就像一个依赖地狱，不利于维护。</p> <h3 id="npm-3与yarn"><a href="#npm-3与yarn" class="header-anchor">#</a> npm@3与yarn</h3> <p>为了解决上述问题，<code>npm3</code>与<code>yarn</code>都选择了扁平化结构，也就是说现在我们看到的<code>node_modules</code>里面的结构不再有依赖嵌套了，都是如下依赖结构：</p> <div class="language-js extra-class"><pre class="language-js"><code>node_modules 
└─ 依赖<span class="token constant">A</span>  
    ├─ index<span class="token punctuation">.</span>js 
    ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json 
    └─ node_modules 
└─ 依赖<span class="token constant">C</span>   
    ├─ index<span class="token punctuation">.</span>js 
    ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json 
    └─ node_modules 
└─ 依赖<span class="token constant">B</span> 
    ├─ index<span class="token punctuation">.</span>js 
    ├─ <span class="token keyword">package</span><span class="token punctuation">.</span>json 
    └─ node_modules 
</code></pre></div><p><code>node_modules</code>下所有的依赖都会平铺到同一层级。由于require寻找包的机制，如果A和C都依赖了B，那么A和C在自己的node_modules中未找到依赖C的时候会向上寻找，并最终在与他们同级的node_modules中找到依赖包C。 这样<strong>就不会出现重复下载的情况。而且依赖层级嵌套也不会太深。因为没有重复的下载，所有的A和C都会寻找并依赖于同一个B包。自然也就解决了实例无法共享数据的问题</strong></p> <p>由于这个扁平化结构的特点，想必大家都遇到了这样的体验，自己明明就只安装了一个依赖包，打开<code>node_modules</code>文件夹一看，里面却有一大堆。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d437870db584278b54081d41655e875~tplv-k3u1fbpfcp-watermark.image?" alt="nz2.jpeg"></p> <p>这种扁平化结构虽然是解决了之前的嵌套问题，但同时也带来了另外一些问题：</p> <ul><li>依赖结构的不确定性</li> <li>扁平化算法的复杂度增加</li> <li>项目中仍然可以非法访问没有声明过的依赖包(幽灵依赖)</li></ul> <h4 id="依赖结构的不确定性"><a href="#依赖结构的不确定性" class="header-anchor">#</a> 依赖结构的不确定性</h4> <p>这个怎么理解，为什么会产生这种问题呢？我们来仔细想想，加入有如下一种依赖结构：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e893818b85174667a3e3cc969a24ddfc~tplv-k3u1fbpfcp-watermark.image?" alt="依赖1.png"></p> <p>A包与B包同时依赖了C包的不同版本，<strong>由于同一目录下不能出现两个同名文件，所以这种情况下同一层级只能存在一个版本的包，另外一个版本还是要被嵌套依赖。</strong></p> <p>那么问题又来了，既然是要一个扁平化一个嵌套，那么这时候是如何确定哪一个扁平化哪一个嵌套的呢？</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/46ddd96fc35c4410b5220a21e162c6c8~tplv-k3u1fbpfcp-watermark.image?" alt="依赖2.png"></p> <p>这两种结构都有可能，准确点说<strong>哪个版本的包被提升，取决于包的安装顺序！</strong></p> <p>这就是为什么会产生依赖结构的<code>不确定</code>问题，也是 <code>lock 文件</code>诞生的原因，无论是<code>package-lock.json</code>(npm 5.x 才出现)还是<code>yarn.lock</code>，都是为了保证 install 之后都产生确定的<code>node_modules</code>结构。</p> <p>尽管如此，npm/yarn 本身还是存在<code>扁平化算法复杂</code>和<code>package 非法访问</code>的问题，影响性能和安全。</p> <h2 id="pnpm"><a href="#pnpm" class="header-anchor">#</a> pnpm</h2> <p>前面说了那么多的<code>npm</code>与<code>yarn</code>的缺点，现在再来看看pnpm是如何解决这些尴尬问题的。</p> <h3 id="什么是pnpm"><a href="#什么是pnpm" class="header-anchor">#</a> 什么是pnpm</h3> <blockquote><p>快速的，节省磁盘空间的包管理工具</p></blockquote> <p>就这么简单，说白了它跟<code>npm</code>与<code>yarn</code>没有区别，都是包管理工具。但它的独特之处在于：</p> <ul><li>包安装速度极快</li> <li>磁盘空间利用非常高效</li></ul> <h3 id="特性"><a href="#特性" class="header-anchor">#</a> 特性</h3> <h4 id="安装包速度快"><a href="#安装包速度快" class="header-anchor">#</a> 安装包速度快</h4> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c438669fdf7c4052a8122cfaecb7e709~tplv-k3u1fbpfcp-watermark.image?" alt="p1.png"></p> <p>从上图可以看出，<code>pnpm</code>的包安装速度明显快于其它包管理工具。那么它为什么会比其它包管理工具快呢？</p> <p>我们来可以来看一下各自的安装流程</p> <ul><li>npm/yarn</li></ul> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3fb59639b17c46248cf912adc9f7cf6c~tplv-k3u1fbpfcp-watermark.image?" alt="npm&amp;yarn.png"></p> <ol><li><p>resolving：首先他们会解析依赖树，决定要fetch哪些安装包。</p></li> <li><p>fetching：安装去fetch依赖的tar包。这个阶段可以同时下载多个，来增加速度。</p></li> <li><p>wrting：然后解压包，根据文件构建出真正的依赖树，这个阶段需要大量文件IO操作。</p></li></ol> <ul><li>pnpm</li></ul> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/747e0b3d70224bbf835b8d2b8a79d4db~tplv-k3u1fbpfcp-watermark.image?" alt="pnpm.png"></p> <p>上图是pnpm的安装流程，可以看到针对每个包的三个流程都是平行的，所以速度会快很多。当然pnpm会多一个阶段，就是通过链接组织起真正的依赖树目录结构。</p> <h4 id="磁盘空间利用非常高效"><a href="#磁盘空间利用非常高效" class="header-anchor">#</a> 磁盘空间利用非常高效</h4> <p>pnpm 内部使用<code>基于内容寻址</code>的文件系统来存储磁盘上所有的文件，这个文件系统出色的地方在于:</p> <ul><li>不会重复安装同一个包。用 npm/yarn 的时候，如果 100 个项目都依赖 lodash，那么 lodash 很可能就被安装了 100 次，磁盘中就有 100 个地方写入了这部分代码。但在使用 pnpm 只会安装一次，磁盘中只有一个地方写入，后面再次使用都会直接使用 <code>hardlink</code>。</li> <li>即使一个包的不同版本，pnpm 也会极大程度地复用之前版本的代码。举个例子，比如 lodash 有 100 个文件，更新版本之后多了一个文件，那么磁盘当中并不会重新写入 101 个文件，而是保留原来的 100 个文件的 <code>hardlink</code>，仅仅写入那<code>一个新增的文件</code>。</li></ul> <h4 id="支持monorepo"><a href="#支持monorepo" class="header-anchor">#</a> 支持monorepo</h4> <p>pnpm 与 npm/yarn 另外一个很大的不同就是支持了 monorepo，pnpm内置了对monorepo的支持，只需在工作空间的根目录创建pnpm-workspace.yaml和.npmrc配置文件，同时还支持多种配置，相比较lerna和yarn workspace，pnpm解决monorepo的同时，也解决了传统方案引入的问题。</p> <blockquote><p>monorepo 的宗旨就是用一个 git 仓库来管理多个子项目，所有的子项目都存放在根目录的<code>packages</code>目录下，那么一个子项目就代表一个<code>package</code>。</p></blockquote> <h3 id="依赖管理"><a href="#依赖管理" class="header-anchor">#</a> 依赖管理</h3> <p>pnpm使用的是npm version 2.x类似的嵌套结构，同时使用.pnpm 以平铺的形式储存着所有的包。然后使用Store + Links和文件资源进行关联。简单说pnpm把会包下载到一个公共目录，如果某个依赖在 sotre 目录中存在了话，那么就会直接从 store 目录里面去 hard-link，避免了二次安装带来的时间消耗，如果依赖在 store 目录里面不存在的话，就会去下载一次。通过Store + hard link的方式，使得项目中不存在NPM依赖地狱问题，从而完美解决了npm3+和yarn中的包重复问题。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0b0f8ce7a6164ce99f726459927cb5e7~tplv-k3u1fbpfcp-watermark.image?" alt="store.jpeg"></p> <p>我们分别用<code>npm</code>与<code>pnpm</code>来安装vite对比看一下</p> <table><thead><tr><th>npm</th> <th>pnpm</th></tr></thead> <tbody><tr><td><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d44c6e37608d4e968928ac9280dc6631~tplv-k3u1fbpfcp-watermark.image?" alt="npm-demo.png"></td> <td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/20a104a288f4488297401d417d6f1a89~tplv-k3u1fbpfcp-watermark.image?" alt="pnpm-demo.png"></td></tr> <tr><td>所有依赖包平铺在<code>node_modules</code>目录，包括直接依赖包以及其他次级依赖包</td> <td><code>node_modules</code>目录下只有<code>.pnpm</code>和直接依赖包，没有其他次级依赖包</td></tr> <tr><td>没有符号链接（软链接）</td> <td>直接依赖包的后面有符号链接（软链接）的标识</td></tr></tbody></table> <p>pnpm安装的<code>vite</code> 所有的依赖都软链至了 <code>node_modules/.pnpm/</code> 中的对应目录。 把 <code>vite</code> 的依赖放置在同一级别避免了循环的软链。</p> <h4 id="软链接-和-硬链接-机制"><a href="#软链接-和-硬链接-机制" class="header-anchor">#</a> 软链接 和 硬链接 机制</h4> <p>pnpm 是通过 hardlink 在全局里面搞个 store 目录来存储 node_modules 依赖里面的 hard link 地址，然后在引用依赖的时候则是通过 symlink 去找到对应虚拟磁盘目录下(.pnpm 目录)的依赖地址。</p> <p>这两者结合在一起工作之后，假如有一个项目依赖了 <code>A@1.0.0</code> 和 <code>B@1.0.0</code> ，那么最后的 node_modules 结构呈现出来的依赖结构可能会是这样的:</p> <div class="language-js extra-class"><pre class="language-js"><code>node_modules
└── <span class="token constant">A</span> <span class="token comment">// symlink to .pnpm/A@1.0.0/node_modules/A</span>
└── <span class="token constant">B</span> <span class="token comment">// symlink to .pnpm/B@1.0.0/node_modules/B</span>
└── <span class="token punctuation">.</span>pnpm
    ├── <span class="token constant">A</span>@<span class="token number">1.0</span><span class="token number">.0</span>
    │   └── node_modules
    │       └── <span class="token constant">A</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token operator">/</span><span class="token constant">A</span>
    │           ├── index<span class="token punctuation">.</span>js
    │           └── <span class="token keyword">package</span><span class="token punctuation">.</span>json
    └── <span class="token constant">B</span>@<span class="token number">1.0</span><span class="token number">.0</span>
        └── node_modules
            └── <span class="token constant">B</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>store<span class="token operator">&gt;</span><span class="token operator">/</span><span class="token constant">B</span>
                ├── index<span class="token punctuation">.</span>js
                └── <span class="token keyword">package</span><span class="token punctuation">.</span>json
</code></pre></div><p><code>node_modules</code> 中的 A 和 B 两个目录会软连接到 .pnpm 这个目录下的真实依赖中，而这些真实依赖则是通过 hard link 存储到全局的 store 目录中。</p> <h4 id="store"><a href="#store" class="header-anchor">#</a> store</h4> <p><strong><code>pnpm</code>下载的依赖全部都存储到<code>store</code>中去了，<code>store</code>是<code>pnpm</code>在硬盘上的公共存储空间。</strong></p> <p><code>pnpm</code>的<code>store</code>在Mac/linux中默认会设置到<code>{home dir}&gt;/.pnpm-store/v3</code>；windows下会设置到当前盘符的根目录下。使用名为 .pnpm-store的文件夹名称。</p> <p>项目中所有<code>.pnpm/依赖名@版本号/node_modules/</code>下的软连接都会连接到<code>pnpm</code>的<code>store</code>中去。</p> <blockquote><p>原文首发地址<a href="https://mp.weixin.qq.com/s/FCXM23JWSkPbUIGriVCPjA" target="_blank" rel="noopener noreferrer">点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，欢迎大家关注公众号 <strong>「前端南玖」</strong>，如果你想进前端交流群一起学习，<a href="https://juejin.cn/pin/7072217320155775007" target="_blank" rel="noopener noreferrer">请点这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><strong>我是南玖，我们下期见！！！</strong></p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/nanjiu/npm/2package-lock.html" class="prev">
          关于package-lock.json
        </a></span> <!----></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/nanjiu/npm/3.html#前言" class="sidebar-link reco-side-前言" data-v-b57cc07c>前言</a></li><li class="level-2" data-v-b57cc07c><a href="/nanjiu/npm/3.html#npm-与-yarn-存在的问题" class="sidebar-link reco-side-npm-与-yarn-存在的问题" data-v-b57cc07c>npm 与 yarn 存在的问题</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/npm/3.html#早期的npm" class="sidebar-link reco-side-早期的npm" data-v-b57cc07c>早期的npm</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/npm/3.html#npm-3与yarn" class="sidebar-link reco-side-npm-3与yarn" data-v-b57cc07c>npm\@3与yarn</a></li><li class="level-2" data-v-b57cc07c><a href="/nanjiu/npm/3.html#pnpm" class="sidebar-link reco-side-pnpm" data-v-b57cc07c>pnpm</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/npm/3.html#什么是pnpm" class="sidebar-link reco-side-什么是pnpm" data-v-b57cc07c>什么是pnpm</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/npm/3.html#特性" class="sidebar-link reco-side-特性" data-v-b57cc07c>特性</a></li><li class="level-3" data-v-b57cc07c><a href="/nanjiu/npm/3.html#依赖管理" class="sidebar-link reco-side-依赖管理" data-v-b57cc07c>依赖管理</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/nanjiu/assets/js/app.76cb9285.js" defer></script><script src="/nanjiu/assets/js/3.21869b4f.js" defer></script><script src="/nanjiu/assets/js/1.9b52f643.js" defer></script><script src="/nanjiu/assets/js/34.a7a58004.js" defer></script>
  </body>
</html>
